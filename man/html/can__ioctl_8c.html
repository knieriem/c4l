<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>can_ioctl.c File Reference</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.18 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="annotated.html">Data Structures</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Data Fields</a> &nbsp; <a class="qindex" href="globals.html">Globals</a> &nbsp; </center>
<hr><h1>can_ioctl.c File Reference</h1> 
<a href="#_details">More...</a>
<p>
<table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td nowrap align=right valign=top>int&nbsp;</td><td valign=bottom><a class="el" href="can__ioctl_8c.html#a5">can_ioctl</a> (__LDDK_IOCTL_PARAM)</td></tr>
<tr><td>&nbsp;</td><td><font size=-1><em>int ioctl(int fd, int request, ...); the CAN controllers control interface</em> <a href="#a5"></a><em></em></font><br><br></td></tr>
</table>
<hr><a name="_details"></a><h2>Detailed Description</h2>
 <dl compact><dt><b>Author: </b></dt><dd>
Heinz-Jürgen Oertel, port GmbH </dl><dl compact><dt><b>Revision: </b></dt><dd>
 1.8 </dl> <dl compact><dt><b>Date: </b></dt><dd>
 2003/08/27 17:49:38 </dl>
<p>
<hr><h2>Function Documentation</h2>
<a name="a5" doxytag="can_ioctl.c::can_ioctl"></a><p>
<table width="100%" cellpadding="2" cellspacing="0" border="0">
  <tr>
    <td class="md">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> int can_ioctl </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">__LDDK_IOCTL_PARAM&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>&nbsp;          </td>
          <td class="md" valign="top">)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>

      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
int ioctl(int fd, int request, ...); the CAN controllers control interface
<p>
<dl compact><dt><b>Parameters: </b></dt><dd>
<table border=0 cellspacing=2 cellpadding=0>
<tr><td valign=top><em>fd</em>&nbsp;</td><td>
The descriptor to change properties </td></tr>
<tr><td valign=top><em>request</em>&nbsp;</td><td>
special configuration request </td></tr>
<tr><td valign=top><em>...</em>&nbsp;</td><td>
traditional a <em>char</em> *argp</td></tr>
</table>
</dl>The <em>ioctl</em> function manipulates the underlying device parameters of the CAN special device. In particular, many operating characteristics of character CAN driver may be controlled with <em>ioctl</em> requests. The argument <em>fd</em> must be an open file descriptor.
<p>
An ioctl request has encoded in it whether the argument is an <b>in</b> parameter or <b>out</b> parameter, and the size of the argument argp in bytes. Macros and defines used in specifying an <em>ioctl</em> request are located in the file can4linux.h .
<p>
The following <em>requests</em> are defined:
<p>
<ul>
<li> <code>COMMAND</code> some commands for start, stop and reset the CAN controller chip <li> <code>CONFIG</code> configure some of the device properties like acceptance filtering, bit timings, mode of the output control register or the optional software message filter configuration(not implemented yet). <li> <code>STATUS</code> request the CAN controllers status <li> <code>SEND</code> a single message over the <em>ioctl</em> interface  <li> <code>RECEIVE</code> poll a receive message <li> <code>CONFIGURERTR</code> configure automatic rtr responses(not implemented)</ul>
The third argument is a parameter structure depending on the request. These are <div class="fragment"><pre><span class="keyword">struct </span><a class="code" href="struct_command__par.html">Command_par</a>
struct Config_par
struct CanStatus_par
struct ConfigureRTR_par
struct Receive_par
struct Send_par
</pre></div> described in can4linux.h<dl compact><dt><b>Acceptance Filtering</b></dt><dd>
<b>Basic</b> <b>CAN</b>. In the case of using standard identifiers in Basic CAN mode for receiving CAN messages only the low bytes are used to set acceptance code and mask for bits ID.10 ... ID.3
<p>
<b>PeliCAN</b>. For acceptance filtering the entries <code>AccCode</code> and <code>AccMask</code> are used like specified in the controllers manual for <b>Single</b> <b>Filter</b> <b>Configuration</b> . Both are 4 byte entries. In the case of using standard identifiers for receiving CAN messages also all 4 bytes can be used. In this case two bytes are used for acceptance code and mask for all 11 identifier bits plus additional the first two data bytes. The SJA1000 is working in the <b>Single</b> <b>Filter</b> \ Mode .</dl>Example for extended message format <div class="fragment"><pre>       Bits
 mask  31 30 .....           4  3  2  1  0
 code
 -------------------------------------------
 ID    28 27 .....           1  0  R  +--+-&gt; unused
                                   T
                                   R

  acccode =  (id &lt;&lt; 3) + (rtr &lt;&lt; 2) 
</pre></div>
<p>
Example for base message format <div class="fragment"><pre>       Bits
 mask  31 30 .....           23 22 21 20 ... 0
 code
 -------------------------------------------
 ID    11 10 .....           1  0  R  +--+-&gt; unused
                                   T
                                   R
</pre></div>
<p>
You have to shift the CAN-ID by 5 bits and two bytes to shift them into ACR0 and ACR1 (acceptance code register) <div class="fragment"><pre>  acccode =  (id &lt;&lt; 21) + (rtr &lt;&lt; 20) 
</pre></div> In case of the base format match the content of bits 0...20 is of no interest, it can be 0x00000 or 0xFFFFF.
<p>
<dl compact><dt><b>Returns: </b></dt><dd>
On success, zero is returned. On error, -1 is returned, and errno is set appropriately.</dl><dl compact><dt><b>Example</b></dt><dd>
<div class="fragment"><pre><a class="code" href="struct_config__par.html">Config_par_t</a>  cfg;
<span class="keyword">volatile</span> <a class="code" href="struct_command__par.html">Command_par_t</a> cmd;


    cmd.<a class="code" href="struct_command__par.html#m0">cmd</a> = CMD_STOP;
    ioctl(can_fd, COMMAND, &amp;cmd);

    cfg.<a class="code" href="struct_config__par.html#m0">target</a> = CONF_ACCM; 
    cfg.val    = acc_mask;
    ioctl(can_fd, CONFIG, &amp;cfg);
    cfg.<a class="code" href="struct_config__par.html#m0">target</a> = CONF_ACCC; 
    cfg.val    = acc_code;
    ioctl(can_fd, CONFIG, &amp;cfg);

    cmd.<a class="code" href="struct_command__par.html#m0">cmd</a> = CMD_START;
    ioctl(can_fd, COMMAND, &amp;cmd);
</pre></div> </dl>    </td>
  </tr>
</table>

<hr>
<address><small>
Generated at
Don Sep 11 16:16:37 CEST 2003
CAN driver can4linux
by
<a href="http://www.port.de">
<img src="port.gif" alt="port GmbH" align="middle" border=0 
width=110 height=53></a>
<a href="mailto:service@port.de"> service@port.de </a>,
 &copy;&nbsp;1997-2003
</small></address>
